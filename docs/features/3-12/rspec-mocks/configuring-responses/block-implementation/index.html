<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]<!--><html class="no-js" lang="en"><!--<![endif]--><head><meta charset="UTF-8" /><meta content="width=device-width, initial-scale=1" name="viewport" /><meta property="og:title" /><meta content="https://rspec.info/features/3-12/rspec-mocks/configuring-responses/block-implementation/" property="og:url" /><meta content="https://rspec.info/images/logo_ogp.png" property="og:image" /><meta content="summary" name="twitter:card" /><meta content="@rspec" name="twitter:site" /><title></title><link href="/stylesheets/pages/features.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /><link href="/blog/feed.xml" rel="alternate" type="application/atom+xml" /></head><body class="features"><header><nav><h1><img src="/images/logo.png" alt="Logo" /><a href="/">RSpec</a></h1><input class="hamburger-toggle" type="checkbox" /><div class="hamburger-icon"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div><ul class="menu"><li><a href="/about">About</a></li><li><a href="/documentation">Documentation</a></li><li><a href="/blog">Blog</a></li><li><a href="/upgrading-from-rspec-2">Upgrade</a></li><li><a href="/help">Get Help</a></li><li><a href="/contributing">Contributing</a></li></ul></nav></header><nav class="top-nav-bar" role="navigation"><ul><li>Library:</li><li><a class="title" href="/features/3-12/rspec-mocks">RSpec Mocks</a><ul aria-haspopup="true" aria-label="submenu"><li><a href="/features/3-12/rspec-core">RSpec Core</a></li><li><a href="/features/3-12/rspec-expectations">RSpec Expectations</a></li><li class="current"><a href="/features/3-12/rspec-mocks">RSpec Mocks</a></li><li><a href="/features/6-0/rspec-rails">RSpec Rails</a></li></ul></li><li>Version:</li><li><a class="title" href="/features/3-12/rspec-mocks">3.12</a><ul aria-haspopup="true" aria-label="submenu"><li class="current"><a href="/features/3-12/rspec-mocks">3.12</a></li></ul></li></ul></nav><section><nav><ul><li><a href="/features/3-12/rspec-mocks/basics">Basics</a><ul><li><a href="/features/3-12/rspec-mocks/basics/test-doubles"> Test Doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/allowing-messages"> Allowing messages</a></li><li><a href="/features/3-12/rspec-mocks/basics/expecting-messages"> Expecting messages</a></li><li><a href="/features/3-12/rspec-mocks/basics/partial-test-doubles"> Partial test doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/null-object-doubles"> Null object doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/spies"> Spies</a></li><li><a href="/features/3-12/rspec-mocks/basics/scope"> Scope</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles">Verifying doubles</a><ul><li><a href="/features/3-12/rspec-mocks/verifying-doubles/instance-doubles"> Using an instance double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/class-doubles"> Using a class double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/object-doubles"> Using an object double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/dynamic-classes"> Dynamic classes</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/partial-doubles"> Partial doubles</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/configuring-responses">Configuring responses</a><ul class="open"><li><a href="/features/3-12/rspec-mocks/configuring-responses/returning-a-value"> Returning a value</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/raising-an-error"> Raising an error</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/throwing"> Throwing</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/yielding"> Yielding</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/calling-the-original-implementation"> Calling the original implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/wrapping-the-original-implementation"> Wrapping the original implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/block-implementation"> Block implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/mixed-responses"> Mixed responses</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/setting-constraints">Setting constraints</a><ul><li><a href="/features/3-12/rspec-mocks/setting-constraints/matching-arguments"> Matching arguments</a></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/receive-counts"> Receive Counts</a></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/message-order"> Message Order</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/mutating-constants">Mutating constants</a><ul><li><a href="/features/3-12/rspec-mocks/mutating-constants/stub-defined-constant"> Stub Defined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/stub-undefined-constant"> Stub Undefined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/hide-defined-constant"> Hide Defined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/hide-undefined-constant"> Hide Undefined Constant</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code">Working with legacy code</a><ul><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/any-instance"> Any Instance</a></li><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/message-chains"> Message Chains</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/old-syntax">Old syntax</a><ul><li><a href="/features/3-12/rspec-mocks/old-syntax/stub"> `stub`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/should-receive"> `should_receive`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/any-instance"> `any_instance`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/stub-chain"> `stub_chain`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/unstub"> Using `unstub`</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/outside-rspec">Outside rspec</a><ul><li><a href="/features/3-12/rspec-mocks/outside-rspec/minitest"> Integrating with Minitest</a></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/any-test-framework"> Integrating with any test framework</a></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/standalone"> Using `rspec-mocks` on its own outside of RSpec (standalone mode)</a></li></ul></li></ul></nav><article><h1>Block implementation</h1>

<p>When you pass a block, RSpec will use your block as the implementation of the method. Any
  arguments (or a block) provided by the caller will be yielded to your block implementation.
  This feature is extremely flexible, and supports many use cases that are not directly
  supported by the more declarative fluent interface.</p>

<p>You can pass a block to any of the fluent interface methods:</p>
<div class="highlight"><pre class="highlight plaintext"><code>* `allow(dbl).to receive(:foo) { do_something }`
* `allow(dbl).to receive(:foo).with("args") { do_something }`
* `allow(dbl).to receive(:foo).once { do_something }`
* `allow(dbl).to receive(:foo).ordered { do_something }`
</code></pre></div>
<p>Some of the more common use cases for block implementations are shown below, but this
  is not an exhaustive list.</p>

<h2>Use a block to specify a return value with a terser syntax</h2>

<p><em>Given</em> a file named &ldquo;return<em>value</em>spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"Specifying a return value using a block"</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"returns the block's return value"</span> <span class="k">do</span>
    <span class="n">dbl</span> <span class="o">=</span> <span class="n">double</span>
    <span class="n">allow</span><span class="p">(</span><span class="n">dbl</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span> <span class="p">{</span> <span class="mi">14</span> <span class="p">}</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">dbl</span><span class="p">.</span><span class="nf">foo</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec return_value_spec.rb</code></p>

<p><em>Then</em> the examples should all pass.</p>

<h2>Use a block to verify arguments</h2>

<p><em>Given</em> a file named &ldquo;verify<em>arguments</em>spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"Verifying arguments using a block"</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"fails when the arguments do not meet the expectations set in the block"</span> <span class="k">do</span>
    <span class="n">dbl</span> <span class="o">=</span> <span class="n">double</span>

    <span class="n">allow</span><span class="p">(</span><span class="n">dbl</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg</span><span class="o">|</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">arg</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"bar"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">dbl</span><span class="p">.</span><span class="nf">foo</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec verify_arguments_spec.rb</code></p>

<p><em>Then</em> it should fail with:</p>
<div class="highlight"><pre class="highlight plaintext"><code>Failure/Error: expect(arg).to eq("bar")
</code></pre></div>
<h2>Use a block to perform a calculation</h2>

<p><em>Given</em> a file named &ldquo;perform<em>calculation</em>spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"Performing a calculation using a block"</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"returns the block's return value"</span> <span class="k">do</span>
    <span class="n">loan</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s2">"Loan"</span><span class="p">,</span> <span class="ss">:amount</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">allow</span><span class="p">(</span><span class="n">loan</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:required_payment_for_rate</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">rate</span><span class="o">|</span>
      <span class="n">loan</span><span class="p">.</span><span class="nf">amount</span> <span class="o">*</span> <span class="n">rate</span>
    <span class="k">end</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">loan</span><span class="p">.</span><span class="nf">required_payment_for_rate</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">loan</span><span class="p">.</span><span class="nf">required_payment_for_rate</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec perform_calculation_spec.rb</code></p>

<p><em>Then</em> the examples should all pass.</p>

<h2>Yield to the caller&rsquo;s block</h2>

<p><em>Given</em> a file named &ldquo;yield<em>to</em>caller_spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"When the caller passes a block"</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"can be yielded to from your implementation block"</span> <span class="k">do</span>
    <span class="n">dbl</span> <span class="o">=</span> <span class="n">double</span>
    <span class="n">allow</span><span class="p">(</span><span class="n">dbl</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span> <span class="p">{</span> <span class="o">|&amp;</span><span class="n">block</span><span class="o">|</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">expect</span> <span class="p">{</span> <span class="o">|</span><span class="n">probe</span><span class="o">|</span> <span class="n">dbl</span><span class="p">.</span><span class="nf">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">probe</span><span class="p">)</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">yield_with_args</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec yield_to_caller_spec.rb</code></p>

<p><em>Then</em> the examples should all pass.</p>

<h2>Delegate to partial double&rsquo;s original implementation within the block</h2>

<p><em>Given</em> a file named &ldquo;delegate<em>to</em>original_spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Calculator</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"When using a block implementation on a partial double"</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"supports delegating to the original implementation"</span> <span class="k">do</span>
    <span class="n">original_add</span> <span class="o">=</span> <span class="no">Calculator</span><span class="p">.</span><span class="nf">method</span><span class="p">(</span><span class="ss">:add</span><span class="p">)</span>

    <span class="n">allow</span><span class="p">(</span><span class="no">Calculator</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:add</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">|</span>
      <span class="n">original_add</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">end</span>

    <span class="n">expect</span><span class="p">(</span><span class="no">Calculator</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec delegate_to_original_spec.rb</code></p>

<p><em>Then</em> the examples should all pass.</p>

<h2>Simulating a transient network failure</h2>

<p><em>Given</em> a file named &ldquo;simulate<em>transient</em>network<em>failure</em>spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"An HTTP API client"</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"can simulate transient network failures"</span> <span class="k">do</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s2">"MyHTTPClient"</span><span class="p">)</span>

    <span class="n">call_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">allow</span><span class="p">(</span><span class="n">client</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:fetch_data</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">call_count</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">call_count</span><span class="p">.</span><span class="nf">odd?</span> <span class="p">?</span> <span class="k">raise</span><span class="p">(</span><span class="s2">"timeout"</span><span class="p">)</span> <span class="p">:</span> <span class="p">{</span> <span class="ss">:count</span> <span class="o">=&gt;</span> <span class="mi">15</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">expect</span> <span class="p">{</span> <span class="n">client</span><span class="p">.</span><span class="nf">fetch_data</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="s2">"timeout"</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">fetch_data</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:count</span> <span class="o">=&gt;</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">expect</span> <span class="p">{</span> <span class="n">client</span><span class="p">.</span><span class="nf">fetch_data</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="s2">"timeout"</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">fetch_data</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:count</span> <span class="o">=&gt;</span> <span class="mi">15</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec simulate_transient_network_failure_spec.rb</code></p>

<p><em>Then</em> the examples should all pass.</p>
</article></section><footer><div>Created with the assistance of Ninefold<img src="/images/brutus-half.png" alt="Brutus" /></div><br /><a href="https://dnsimple.link/resolving-rspec" target="_blank">Resolving with<br /><img src="https://cdn.dnsimple.com/assets/resolving-with-us/logo-dark.png" alt="DNSimple" style="width:100px;" /></a></footer></body><script src="/javascripts/asciinema-player.js"></script></html>