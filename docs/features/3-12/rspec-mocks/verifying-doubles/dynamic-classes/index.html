<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]<!--><html class="no-js" lang="en"><!--<![endif]--><head><meta charset="UTF-8" /><meta content="width=device-width, initial-scale=1" name="viewport" /><meta property="og:title" /><meta content="https://rspec.info/features/3-12/rspec-mocks/verifying-doubles/dynamic-classes/" property="og:url" /><meta content="https://rspec.info/images/logo_ogp.png" property="og:image" /><meta content="summary" name="twitter:card" /><meta content="@rspec" name="twitter:site" /><title></title><link href="/stylesheets/pages/features.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /><link href="/blog/feed.xml" rel="alternate" type="application/atom+xml" /></head><body class="features"><header><nav><h1><img src="/images/logo.png" alt="Logo" /><a href="/">RSpec</a></h1><input class="hamburger-toggle" type="checkbox" /><div class="hamburger-icon"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div><ul class="menu"><li><a href="/about">About</a></li><li><a href="/documentation">Documentation</a></li><li><a href="/blog">Blog</a></li><li><a href="/upgrading-from-rspec-2">Upgrade</a></li><li><a href="/help">Get Help</a></li><li><a href="/contributing">Contributing</a></li></ul></nav></header><nav class="top-nav-bar" role="navigation"><ul><li>Library:</li><li><a class="title" href="/features/3-12/rspec-mocks">RSpec Mocks</a><ul aria-haspopup="true" aria-label="submenu"><li><a href="/features/3-12/rspec-core">RSpec Core</a></li><li><a href="/features/3-12/rspec-expectations">RSpec Expectations</a></li><li class="current"><a href="/features/3-12/rspec-mocks">RSpec Mocks</a></li><li><a href="/features/6-1/rspec-rails">RSpec Rails</a></li></ul></li><li>Version:</li><li><a class="title" href="/features/3-12/rspec-mocks">3.12</a><ul aria-haspopup="true" aria-label="submenu"><li><a href="/features/3-13/rspec-mocks">3.13</a></li><li class="current"><a href="/features/3-12/rspec-mocks">3.12</a></li></ul></li></ul></nav><section><nav><ul><li><a href="/features/3-12/rspec-mocks/basics/">Basics</a><ul><li><a href="/features/3-12/rspec-mocks/basics/test-doubles/"> Test Doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/allowing-messages/"> Allowing messages</a></li><li><a href="/features/3-12/rspec-mocks/basics/expecting-messages/"> Expecting messages</a></li><li><a href="/features/3-12/rspec-mocks/basics/partial-test-doubles/"> Partial test doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/null-object-doubles/"> Null object doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/spies/"> Spies</a></li><li><a href="/features/3-12/rspec-mocks/basics/scope/"> Scope</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/">Verifying doubles</a><ul class="open"><li><a href="/features/3-12/rspec-mocks/verifying-doubles/instance-doubles/"> Using an instance double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/class-doubles/"> Using a class double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/object-doubles/"> Using an object double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/dynamic-classes/"> Dynamic classes</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/partial-doubles/"> Partial doubles</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/">Configuring responses</a><ul><li><a href="/features/3-12/rspec-mocks/configuring-responses/returning-a-value/"> Returning a value</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/raising-an-error/"> Raising an error</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/throwing/"> Throwing</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/yielding/"> Yielding</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/calling-the-original-implementation/"> Calling the original implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/wrapping-the-original-implementation/"> Wrapping the original implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/block-implementation/"> Block implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/mixed-responses/"> Mixed responses</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/">Setting constraints</a><ul><li><a href="/features/3-12/rspec-mocks/setting-constraints/matching-arguments/"> Matching arguments</a></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/receive-counts/"> Receive Counts</a></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/message-order/"> Message Order</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/">Mutating constants</a><ul><li><a href="/features/3-12/rspec-mocks/mutating-constants/stub-defined-constant/"> Stub Defined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/stub-undefined-constant/"> Stub Undefined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/hide-defined-constant/"> Hide Defined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/hide-undefined-constant/"> Hide Undefined Constant</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/">Working with legacy code</a><ul><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/any-instance/"> Any Instance</a></li><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/message-chains/"> Message Chains</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/old-syntax/">Old syntax</a><ul><li><a href="/features/3-12/rspec-mocks/old-syntax/stub/"> `stub`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/should-receive/"> `should_receive`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/any-instance/"> `any_instance`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/stub-chain/"> `stub_chain`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/unstub/"> Using `unstub`</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/">Outside rspec</a><ul><li><a href="/features/3-12/rspec-mocks/outside-rspec/minitest/"> Integrating with Minitest</a></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/any-test-framework/"> Integrating with any test framework</a></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/standalone/"> Using `rspec-mocks` on its own outside of RSpec (standalone mode)</a></li></ul></li></ul></nav><article><h1>Dynamic classes</h1>

<p>Verifying instance doubles do not support methods which the class reports to not exist
  since an actual instance of the class would be required to verify against. This is commonly
  the case when <code>method_missing</code> is used.</p>

<p>There are a few ways to work around this. If the object has already been loaded you may
  consider using an <a href="/features/3-12/rspec-mocks/verifying-doubles/object-doubles/"><code>object_double</code></a>, but that cannot work if you are testing in isolation.
  Alternatively you could implement the methods directly (calling <code>super</code> to return the <code>method_missing</code> definition).</p>

<p>Some of these classes may have methods to define these methods on the objects at runtime.
  (For example, <code>ActiveRecord</code> does this to define methods from database columns.) For these
  cases we provide an API which can be used to customise verifying doubles on creation. We
  use this ourselves in <code>rspec-rails</code> to set up some niceties for you.</p>

<p>These types of methods are supported at class level (with <code>class_double</code>) however, since
  <code>respond_to?</code> can be queried directly on the class.</p>

<h2>Background</h2>

<p><em>Given</em> a file named &ldquo;lib/fake<em>active</em>record.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">FakeActiveRecord</span>
  <span class="no">COLUMNS</span> <span class="o">=</span> <span class="sx">%w[name email]</span>

  <span class="k">def</span> <span class="nf">respond_to_missing?</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
    <span class="no">COLUMNS</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">method_name</span><span class="p">.</span><span class="nf">to_s</span><span class="p">)</span> <span class="o">||</span> <span class="k">super</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
      <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">"@</span><span class="si">#{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">define_attribute_methods</span>
    <span class="no">COLUMNS</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span>
      <span class="n">define_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="p">{</span> <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">"@</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>Given</em> a file named &ldquo;spec/user_spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'user'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'can be doubled'</span> <span class="k">do</span>
    <span class="n">instance_double</span><span class="p">(</span><span class="s2">"User"</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Don"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h2>Fails with method missing</h2>

<p><em>Given</em> a file named &ldquo;lib/user.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'fake_active_record'</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">FakeActiveRecord</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec spec/user_spec.rb</code></p>

<p><em>Then</em> the output should contain &ldquo;1 example, 1 failure&rdquo;.</p>

<h2>Workaround with explicit definitions</h2>

<p><em>Given</em> a file named &ldquo;lib/user.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'fake_active_record'</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">FakeActiveRecord</span>
  <span class="k">def</span> <span class="nf">name</span><span class="p">;</span>  <span class="k">super</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nf">email</span><span class="p">;</span> <span class="k">super</span> <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec spec/user_spec.rb</code></p>

<p><em>Then</em> the examples should all pass.</p>

<h2>Workaround using callback</h2>

<p><em>Given</em> a file named &ldquo;lib/user.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'fake_active_record'</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">FakeActiveRecord</span>
<span class="k">end</span>
</code></pre></div>
<p><em>And</em> a file named &ldquo;spec/fake<em>record</em>helper.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">configuration</span><span class="p">.</span><span class="nf">mock_with</span><span class="p">(</span><span class="ss">:rspec</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">before_verifying_doubles</span> <span class="k">do</span> <span class="o">|</span><span class="n">reference</span><span class="o">|</span>
    <span class="n">reference</span><span class="p">.</span><span class="nf">target</span><span class="p">.</span><span class="nf">define_attribute_methods</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="c1">#</span>
<span class="c1"># or you can use:</span>
<span class="c1">#</span>
<span class="c1"># RSpec::Mocks.configuration.before_verifying_doubles do |reference|</span>
<span class="c1">#   reference.target.define_attribute_methods</span>
<span class="c1"># end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec -r fake_record_helper spec/user_spec.rb</code></p>

<p><em>Then</em> the examples should all pass.</p>
</article></section><footer><div>Created with the assistance of Ninefold<img src="/images/brutus-half.png" alt="Brutus" /></div><br /><a href="https://dnsimple.link/resolving-rspec" target="_blank">Resolving with<br /><img src="https://cdn.dnsimple.com/assets/resolving-with-us/logo-dark.png" alt="DNSimple" style="width:100px;" /></a></footer></body><script src="/javascripts/asciinema-player.js"></script></html>