<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]<!--><html class="no-js" lang="en"><!--<![endif]--><head><meta charset="UTF-8" /><meta content="width=device-width, initial-scale=1" name="viewport" /><meta property="og:title" /><meta content="https://rspec.info/features/3-12/rspec-mocks/verifying-doubles/instance-doubles/" property="og:url" /><meta content="https://rspec.info/images/logo_ogp.png" property="og:image" /><meta content="summary" name="twitter:card" /><meta content="@rspec" name="twitter:site" /><title></title><link href="/stylesheets/pages/features.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /><link href="/blog/feed.xml" rel="alternate" type="application/atom+xml" /></head><body class="features"><header><nav><h1><img src="/images/logo.png" alt="Logo" /><a href="/">RSpec</a></h1><input class="hamburger-toggle" type="checkbox" /><div class="hamburger-icon"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div><ul class="menu"><li><a href="/about">About</a></li><li><a href="/documentation">Documentation</a></li><li><a href="/blog">Blog</a></li><li><a href="/upgrading-from-rspec-2">Upgrade</a></li><li><a href="/help">Get Help</a></li><li><a href="/contributing">Contributing</a></li></ul></nav></header><nav class="top-nav-bar" role="navigation"><ul><li>Library:</li><li><a class="title" href="/features/3-12/rspec-mocks">RSpec Mocks</a><ul aria-haspopup="true" aria-label="submenu"><li><a href="/features/3-12/rspec-core">RSpec Core</a></li><li><a href="/features/3-12/rspec-expectations">RSpec Expectations</a></li><li class="current"><a href="/features/3-12/rspec-mocks">RSpec Mocks</a></li><li><a href="/features/6-1/rspec-rails">RSpec Rails</a></li></ul></li><li>Version:</li><li><a class="title" href="/features/3-12/rspec-mocks">3.12</a><ul aria-haspopup="true" aria-label="submenu"><li class="current"><a href="/features/3-12/rspec-mocks">3.12</a></li><li><a href="/features/3-13/rspec-mocks">3.13</a></li></ul></li></ul></nav><section><nav><ul><li><a href="/features/3-12/rspec-mocks/basics/">Basics</a><ul><li><a href="/features/3-12/rspec-mocks/basics/test-doubles/"> Test Doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/allowing-messages/"> Allowing messages</a></li><li><a href="/features/3-12/rspec-mocks/basics/expecting-messages/"> Expecting messages</a></li><li><a href="/features/3-12/rspec-mocks/basics/partial-test-doubles/"> Partial test doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/null-object-doubles/"> Null object doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/spies/"> Spies</a></li><li><a href="/features/3-12/rspec-mocks/basics/scope/"> Scope</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/">Verifying doubles</a><ul class="open"><li><a href="/features/3-12/rspec-mocks/verifying-doubles/instance-doubles/"> Using an instance double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/class-doubles/"> Using a class double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/object-doubles/"> Using an object double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/dynamic-classes/"> Dynamic classes</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/partial-doubles/"> Partial doubles</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/">Configuring responses</a><ul><li><a href="/features/3-12/rspec-mocks/configuring-responses/returning-a-value/"> Returning a value</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/raising-an-error/"> Raising an error</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/throwing/"> Throwing</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/yielding/"> Yielding</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/calling-the-original-implementation/"> Calling the original implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/wrapping-the-original-implementation/"> Wrapping the original implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/block-implementation/"> Block implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/mixed-responses/"> Mixed responses</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/">Setting constraints</a><ul><li><a href="/features/3-12/rspec-mocks/setting-constraints/matching-arguments/"> Matching arguments</a></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/receive-counts/"> Receive Counts</a></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/message-order/"> Message Order</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/">Mutating constants</a><ul><li><a href="/features/3-12/rspec-mocks/mutating-constants/stub-defined-constant/"> Stub Defined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/stub-undefined-constant/"> Stub Undefined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/hide-defined-constant/"> Hide Defined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/hide-undefined-constant/"> Hide Undefined Constant</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/">Working with legacy code</a><ul><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/any-instance/"> Any Instance</a></li><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/message-chains/"> Message Chains</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/old-syntax/">Old syntax</a><ul><li><a href="/features/3-12/rspec-mocks/old-syntax/stub/"> `stub`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/should-receive/"> `should_receive`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/any-instance/"> `any_instance`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/stub-chain/"> `stub_chain`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/unstub/"> Using `unstub`</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/">Outside rspec</a><ul><li><a href="/features/3-12/rspec-mocks/outside-rspec/minitest/"> Integrating with Minitest</a></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/any-test-framework/"> Integrating with any test framework</a></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/standalone/"> Using `rspec-mocks` on its own outside of RSpec (standalone mode)</a></li></ul></li></ul></nav><article><h1>Using an instance double</h1>

<p>An <code>instance_double</code> is the most common type of verifying double. It takes a class name or
  object as its first argument, then verifies that any methods being stubbed would be present
  on an <em>instance</em> of that class. In addition, when it receives messages, it verifies that the
  provided arguments are supported by the method signature, both in terms of arity and
  allowed or required keyword arguments, if any. The same argument verification happens
  when you <a href="/features/3-12/rspec-mocks/setting-constraints/matching-arguments/">constrain the arguments</a> using <code>with</code>.</p>

<p>For methods handled by <code>method_missing</code>, see <a href="/features/3-12/rspec-mocks/verifying-doubles/dynamic-classes/">dynamic classes</a>.</p>

<h2>Background</h2>

<p><em>Given</em> a file named &ldquo;app/models/user.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:notifier</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">suspend!</span>
    <span class="n">notifier</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="s2">"suspended as"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>Given</em> a file named &ldquo;spec/unit_helper.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="vg">$LOAD_PATH</span><span class="p">.</span><span class="nf">unshift</span><span class="p">(</span><span class="s2">"app/models"</span><span class="p">)</span>
</code></pre></div>
<p><em>Given</em> a file named &ldquo;spec/spec_helper.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'unit_helper'</span>

<span class="nb">require</span> <span class="s1">'user'</span>
<span class="nb">require</span> <span class="s1">'console_notifier'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">mock_with</span> <span class="ss">:rspec</span> <span class="k">do</span> <span class="o">|</span><span class="n">mocks</span><span class="o">|</span>

    <span class="c1"># This option should be set when all dependencies are being loaded</span>
    <span class="c1"># before a spec run, as is the case in a typical spec helper. It will</span>
    <span class="c1"># cause any verifying double instantiation for a class that does not</span>
    <span class="c1"># exist to raise, protecting against incorrectly spelt names.</span>
    <span class="n">mocks</span><span class="p">.</span><span class="nf">verify_doubled_constant_names</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>Given</em> a file named &ldquo;spec/unit/user_spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'unit_helper'</span>

<span class="nb">require</span> <span class="s1">'user'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">User</span><span class="p">,</span> <span class="s1">'#suspend!'</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'notifies the console'</span> <span class="k">do</span>
    <span class="n">notifier</span> <span class="o">=</span> <span class="n">instance_double</span><span class="p">(</span><span class="s2">"ConsoleNotifier"</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">notifier</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:notify</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span><span class="s2">"suspended as"</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">suspend!</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h2>Spec passes in isolation</h2>

<p><em>When</em> I run <code>rspec spec/unit/user_spec.rb</code></p>

<p><em>Then</em> the examples should all pass.</p>

<h2>Spec passes with dependencies loaded and method implemented</h2>

<p><em>Given</em> a file named &ldquo;app/models/console_notifier.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ConsoleNotifier</span>
  <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="n">message</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec -r./spec/spec_helper spec/unit/user_spec.rb</code></p>

<p><em>Then</em> the examples should all pass.</p>

<h2>Spec fails with dependencies loaded and method unimplemented</h2>

<p><em>Given</em> a file named &ldquo;app/models/console_notifier.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ConsoleNotifier</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec -r./spec/spec_helper spec/unit/user_spec.rb</code></p>

<p><em>Then</em> the output should contain &ldquo;1 example, 1 failure&rdquo;</p>

<p><em>And</em> the output should contain &ldquo;ConsoleNotifier class does not implement the instance method:&rdquo;.</p>

<h2>Spec fails with dependencies loaded and incorrect arity</h2>

<p><em>Given</em> a file named &ldquo;app/models/console_notifier.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ConsoleNotifier</span>
  <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="n">color</span> <span class="o">+</span> <span class="n">message</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec -r./spec/spec_helper spec/unit/user_spec.rb</code></p>

<p><em>Then</em> the output should contain &ldquo;1 example, 1 failure&rdquo;</p>

<p><em>And</em> the output should contain &ldquo;Wrong number of arguments.&rdquo;.</p>
</article></section><footer><div>Created with the assistance of Ninefold<img src="/images/brutus-half.png" alt="Brutus" /></div><br /><a href="https://dnsimple.link/resolving-rspec" target="_blank">Resolving with<br /><img src="https://cdn.dnsimple.com/assets/resolving-with-us/logo-dark.png" alt="DNSimple" style="width:100px;" /></a></footer></body><script src="/javascripts/asciinema-player.js"></script></html>