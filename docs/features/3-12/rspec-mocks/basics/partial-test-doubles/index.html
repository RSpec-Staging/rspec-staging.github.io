<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]<!--><html class="no-js" lang="en"><!--<![endif]--><head><meta charset="UTF-8" /><meta content="width=device-width, initial-scale=1" name="viewport" /><meta property="og:title" /><meta content="https://rspec.info/features/3-12/rspec-mocks/basics/partial-test-doubles/" property="og:url" /><meta content="https://rspec.info/images/logo_ogp.png" property="og:image" /><meta content="summary" name="twitter:card" /><meta content="@rspec" name="twitter:site" /><title></title><link href="/stylesheets/pages/features.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /><link href="/blog/feed.xml" rel="alternate" type="application/atom+xml" /></head><body class="features"><header><nav><h1><img src="/images/logo.png" alt="Logo" /><a href="/">RSpec</a></h1><input class="hamburger-toggle" type="checkbox" /><div class="hamburger-icon"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div><ul class="menu"><li><a href="/about">About</a></li><li><a href="/documentation">Documentation</a></li><li><a href="/blog">Blog</a></li><li><a href="/upgrading-from-rspec-2">Upgrade</a></li><li><a href="/help">Get Help</a></li><li><a href="/contributing">Contributing</a></li></ul></nav></header><nav class="top-nav-bar" role="navigation"><ul><li>Library:</li><li><a class="title" href="/features/3-12/rspec-mocks">RSpec Mocks</a><ul aria-haspopup="true" aria-label="submenu"><li><a href="/features/3-12/rspec-core">RSpec Core</a></li><li><a href="/features/3-12/rspec-expectations">RSpec Expectations</a></li><li class="current"><a href="/features/3-12/rspec-mocks">RSpec Mocks</a></li><li><a href="/features/6-0/rspec-rails">RSpec Rails</a></li></ul></li><li>Version:</li><li><a class="title" href="/features/3-12/rspec-mocks">3.12</a><ul aria-haspopup="true" aria-label="submenu"><li class="current"><a href="/features/3-12/rspec-mocks">3.12</a></li></ul></li></ul></nav><section><nav><ul><li><a href="/features/3-12/rspec-mocks/basics">Basics</a><ul class="open"><li><a href="/features/3-12/rspec-mocks/basics/test-doubles"> Test Doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/allowing-messages"> Allowing messages</a></li><li><a href="/features/3-12/rspec-mocks/basics/expecting-messages"> Expecting messages</a></li><li><a href="/features/3-12/rspec-mocks/basics/partial-test-doubles"> Partial test doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/null-object-doubles"> Null object doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/spies"> Spies</a></li><li><a href="/features/3-12/rspec-mocks/basics/scope"> Scope</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles">Verifying doubles</a><ul><li><a href="/features/3-12/rspec-mocks/verifying-doubles/instance-doubles"> Using an instance double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/class-doubles"> Using a class double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/object-doubles"> Using an object double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/dynamic-classes"> Dynamic classes</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/partial-doubles"> Partial doubles</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/configuring-responses">Configuring responses</a><ul><li><a href="/features/3-12/rspec-mocks/configuring-responses/returning-a-value"> Returning a value</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/raising-an-error"> Raising an error</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/throwing"> Throwing</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/yielding"> Yielding</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/calling-the-original-implementation"> Calling the original implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/wrapping-the-original-implementation"> Wrapping the original implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/block-implementation"> Block implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/mixed-responses"> Mixed responses</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/setting-constraints">Setting constraints</a><ul><li><a href="/features/3-12/rspec-mocks/setting-constraints/matching-arguments"> Matching arguments</a></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/receive-counts"> Receive Counts</a></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/message-order"> Message Order</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/mutating-constants">Mutating constants</a><ul><li><a href="/features/3-12/rspec-mocks/mutating-constants/stub-defined-constant"> Stub Defined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/stub-undefined-constant"> Stub Undefined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/hide-defined-constant"> Hide Defined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/hide-undefined-constant"> Hide Undefined Constant</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code">Working with legacy code</a><ul><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/any-instance"> Any Instance</a></li><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/message-chains"> Message Chains</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/old-syntax">Old syntax</a><ul><li><a href="/features/3-12/rspec-mocks/old-syntax/stub"> `stub`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/should-receive"> `should_receive`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/any-instance"> `any_instance`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/stub-chain"> `stub_chain`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/unstub"> Using `unstub`</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/outside-rspec">Outside rspec</a><ul><li><a href="/features/3-12/rspec-mocks/outside-rspec/minitest"> Integrating with Minitest</a></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/any-test-framework"> Integrating with any test framework</a></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/standalone"> Using `rspec-mocks` on its own outside of RSpec (standalone mode)</a></li></ul></li></ul></nav><article><h1>Partial test doubles</h1>

<p>A <em>partial test double</em> is an extension of a real object in a system that is instrumented with
  test-double like behaviour in the context of a test. This technique is very common in Ruby
  because we often see class objects acting as global namespaces for methods. For example,
  in Rails:</p>
<div class="highlight"><pre class="highlight ruby"><code>  <span class="n">person</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s2">"person"</span><span class="p">)</span>
  <span class="n">allow</span><span class="p">(</span><span class="no">Person</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:find</span><span class="p">)</span> <span class="p">{</span> <span class="n">person</span> <span class="p">}</span>
</code></pre></div>
<p>In this case we&rsquo;re instrumenting Person to return the person object we&rsquo;ve defined whenever
  it receives the <code>find</code> message. We can also set a message expectation so that the example
  fails if <code>find</code> is not called:</p>
<div class="highlight"><pre class="highlight ruby"><code>  <span class="n">person</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s2">"person"</span><span class="p">)</span>
  <span class="n">expect</span><span class="p">(</span><span class="no">Person</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:find</span><span class="p">)</span> <span class="p">{</span> <span class="n">person</span> <span class="p">}</span>
</code></pre></div>
<p>RSpec replaces the method we&rsquo;re stubbing or mocking with its own test-double like method.
  At the end of the example, RSpec verifies any message expectations, and then restores the
  original methods.</p>

<p>Note: we recommend enabling the <a href="/features/3-12/rspec-mocks/verifying-doubles/partial-doubles"><code>verify_partial_doubles</code></a> config option.</p>

<h2>Only the specified methods are redefined</h2>

<p><em>Given</em> a file named &ldquo;partial<em>double</em>spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"A partial double"</span> <span class="k">do</span>
  <span class="c1"># Note: stubbing a string like this is a terrible idea.</span>
  <span class="c1">#       This is just for demonstration purposes.</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:string</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"a string"</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">allow</span><span class="p">(</span><span class="n">string</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:length</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"redefines the specified methods"</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="nf">length</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"does not effect other methods"</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="nf">reverse</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"gnirts a"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec partial_double_spec.rb</code></p>

<p><em>Then</em> the examples should all pass.</p>

<h2>The original method is restored when the example completes</h2>

<p><em>Given</em> a file named &ldquo;partial<em>double</em>spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">User</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="ss">:original_return_value</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"A partial double"</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"redefines a method"</span> <span class="k">do</span>
    <span class="n">allow</span><span class="p">(</span><span class="no">User</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:find</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="ss">:redefined</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:redefined</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"restores the redefined method after the example completes"</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:original_return_value</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec partial_double_spec.rb --order defined</code></p>

<p><em>Then</em> the examples should all pass.</p>
</article></section><footer><div>Created with the assistance of Ninefold<img src="/images/brutus-half.png" alt="Brutus" /></div><br /><a href="https://dnsimple.link/resolving-rspec" target="_blank">Resolving with<br /><img src="https://cdn.dnsimple.com/assets/resolving-with-us/logo-dark.png" alt="DNSimple" style="width:100px;" /></a></footer></body><script src="/javascripts/asciinema-player.js"></script></html>