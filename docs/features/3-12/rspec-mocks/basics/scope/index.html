<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]<!--><html class="no-js" lang="en"><!--<![endif]--><head><meta charset="UTF-8" /><meta content="width=device-width, initial-scale=1" name="viewport" /><meta property="og:title" /><meta content="https://rspec.info/features/3-12/rspec-mocks/basics/scope/" property="og:url" /><meta content="https://rspec.info/images/logo_ogp.png" property="og:image" /><meta content="summary" name="twitter:card" /><meta content="@rspec" name="twitter:site" /><title></title><link href="/stylesheets/pages/features.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet" type="text/css" /><link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /><link href="/blog/feed.xml" rel="alternate" type="application/atom+xml" /></head><body class="features"><header><nav><h1><img src="/images/logo.png" alt="Logo" /><a href="/">RSpec</a></h1><input class="hamburger-toggle" type="checkbox" /><div class="hamburger-icon"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div><ul class="menu"><li><a href="/about">About</a></li><li><a href="/documentation">Documentation</a></li><li><a href="/blog">Blog</a></li><li><a href="/upgrading-from-rspec-2">Upgrade</a></li><li><a href="/help">Get Help</a></li><li><a href="/contributing">Contributing</a></li></ul></nav></header><nav class="top-nav-bar" role="navigation"><ul><li>Library:</li><li><a class="title">RSpec Mocks</a><ul aria-haspopup="true" aria-label="submenu"><li><a href="/features/3-12/rspec-core">RSpec Core</a></li><li><a href="/features/3-12/rspec-expectations">RSpec Expectations</a></li><li class="current"><a href="/features/3-12/rspec-mocks">RSpec Mocks</a></li><li><a href="/features/6-0/rspec-rails">RSpec Rails</a></li></ul></li><li>Version:</li><li><a class="title">3.12</a><ul aria-haspopup="true" aria-label="submenu"><li class="current"><a href="/features/3-12/rspec-mocks">3.12</a></li></ul></li></ul></nav><section><nav><ul><li><a href="/features/3-12/rspec-mocks/basics">Basics</a><ul class="open"><li><a href="/features/3-12/rspec-mocks/basics/test-doubles"> Test Doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/allowing-messages"> Allowing messages</a></li><li><a href="/features/3-12/rspec-mocks/basics/expecting-messages"> Expecting messages</a></li><li><a href="/features/3-12/rspec-mocks/basics/partial-test-doubles"> Partial test doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/null-object-doubles"> Null object doubles</a></li><li><a href="/features/3-12/rspec-mocks/basics/spies"> Spies</a></li><li><a href="/features/3-12/rspec-mocks/basics/scope"> Scope</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles">Verifying doubles</a><ul><li><a href="/features/3-12/rspec-mocks/verifying-doubles/instance-doubles"> Using an instance double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/class-doubles"> Using a class double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/object-doubles"> Using an object double</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/dynamic-classes"> Dynamic classes</a></li><li><a href="/features/3-12/rspec-mocks/verifying-doubles/partial-doubles"> Partial doubles</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/configuring-responses">Configuring responses</a><ul><li><a href="/features/3-12/rspec-mocks/configuring-responses/returning-a-value"> Returning a value</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/raising-an-error"> Raising an error</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/throwing"> Throwing</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/yielding"> Yielding</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/calling-the-original-implementation"> Calling the original implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/wrapping-the-original-implementation"> Wrapping the original implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/block-implementation"> Block implementation</a></li><li><a href="/features/3-12/rspec-mocks/configuring-responses/mixed-responses"> Mixed responses</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/setting-constraints">Setting constraints</a><ul><li><a href="/features/3-12/rspec-mocks/setting-constraints/matching-arguments"> Matching arguments</a></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/receive-counts"> Receive Counts</a></li><li><a href="/features/3-12/rspec-mocks/setting-constraints/message-order"> Message Order</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/mutating-constants">Mutating constants</a><ul><li><a href="/features/3-12/rspec-mocks/mutating-constants/stub-defined-constant"> Stub Defined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/stub-undefined-constant"> Stub Undefined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/hide-defined-constant"> Hide Defined Constant</a></li><li><a href="/features/3-12/rspec-mocks/mutating-constants/hide-undefined-constant"> Hide Undefined Constant</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code">Working with legacy code</a><ul><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/any-instance"> Any Instance</a></li><li><a href="/features/3-12/rspec-mocks/working-with-legacy-code/message-chains"> Message Chains</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/old-syntax">Old syntax</a><ul><li><a href="/features/3-12/rspec-mocks/old-syntax/stub"> `stub`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/should-receive"> `should_receive`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/any-instance"> `any_instance`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/stub-chain"> `stub_chain`</a></li><li><a href="/features/3-12/rspec-mocks/old-syntax/unstub"> Using `unstub`</a></li></ul></li><li><a href="/features/3-12/rspec-mocks/outside-rspec">Outside rspec</a><ul><li><a href="/features/3-12/rspec-mocks/outside-rspec/minitest"> Integrating with Minitest</a></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/any-test-framework"> Integrating with any test framework</a></li><li><a href="/features/3-12/rspec-mocks/outside-rspec/standalone"> Using `rspec-mocks` on its own outside of RSpec (standalone mode)</a></li></ul></li></ul></nav><article><h1>Scope</h1>

<p>All rspec-mocks constructs have a per-example lifecycle. Message expectations are verified
  after each example. Doubles, method stubs, stubbed constants, etc. are all cleaned up after
  each example. This ensures that each example can be run in isolation, and in any order.</p>

<p>It is perfectly fine to set up doubles, stubs, and message expectations in a
  <code>before(:example)</code> hook, as that hook is executed in the scope of the example:</p>
<div class="highlight"><pre class="highlight ruby"><code>  <span class="n">before</span><span class="p">(</span><span class="ss">:example</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">allow</span><span class="p">(</span><span class="no">MyClass</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre></div>
<p>Since <code>before(:context)</code> runs outside the scope of any individual example, usage of
  rspec-mocks features is not supported there. You can, however, create a temporary scope in
  <em>any</em> arbitrary context, including in a <code>before(:context)</code> hook, using
  <code>RSpec::Mocks.with_temporary_scope { }</code>.</p>

<h2>Cannot create doubles in a <code>before(:context)</code> hook</h2>

<p><em>Given</em> a file named &ldquo;before<em>context</em>spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"Creating a double in a before(:context) hook"</span> <span class="k">do</span>
  <span class="n">before</span><span class="p">(</span><span class="ss">:context</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@dbl</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">:foo</span> <span class="o">=&gt;</span> <span class="mi">13</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"fails before it gets to the examples"</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="vi">@dbl</span><span class="p">.</span><span class="nf">foo</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec before_context_spec.rb</code></p>

<p><em>Then</em> it should fail with:</p>
<div class="highlight"><pre class="highlight plaintext"><code>The use of doubles or partial doubles from rspec-mocks outside of the per-test lifecycle is not supported.
</code></pre></div>
<h2>Use <code>with_temporary_scope</code> to create and use a double in a <code>before(:context)</code> hook</h2>

<p><em>Given</em> a file named &ldquo;with<em>temporary</em>scope_spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"Creating a double in a before(:context) hook"</span> <span class="k">do</span>
  <span class="n">before</span><span class="p">(</span><span class="ss">:context</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="p">.</span><span class="nf">with_temporary_scope</span> <span class="k">do</span>
      <span class="n">dbl</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">:foo</span> <span class="o">=&gt;</span> <span class="mi">13</span><span class="p">)</span>
      <span class="vi">@result</span> <span class="o">=</span> <span class="n">dbl</span><span class="p">.</span><span class="nf">foo</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"allows a double to be created and used from within a with_temporary_scope block"</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="vi">@result</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec with_temporary_scope_spec.rb</code></p>

<p><em>Then</em> the examples should all pass.</p>

<h2>Doubles cannot be reused in another example</h2>

<p><em>Given</em> a file named &ldquo;leak<em>test</em>double_spec.rb&rdquo; with:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Account</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="nb">attr_accessor</span> <span class="ss">:logger</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@balance</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">end</span>

  <span class="nb">attr_reader</span> <span class="ss">:balance</span>

  <span class="k">def</span> <span class="nf">credit</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
    <span class="vi">@balance</span> <span class="o">+=</span> <span class="n">amount</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">"Credited $</span><span class="si">#{</span><span class="n">amount</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Account</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"logs each credit"</span> <span class="k">do</span>
    <span class="no">Account</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s2">"Logger"</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">logger</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:log</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span><span class="s2">"Credited $15"</span><span class="p">)</span>
    <span class="n">account</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">new</span>
    <span class="n">account</span><span class="p">.</span><span class="nf">credit</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"keeps track of the balance"</span> <span class="k">do</span>
    <span class="n">account</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">new</span>
    <span class="n">expect</span> <span class="p">{</span> <span class="n">account</span><span class="p">.</span><span class="nf">credit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="n">account</span><span class="p">.</span><span class="nf">balance</span> <span class="p">}.</span><span class="nf">by</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>When</em> I run <code>rspec leak_test_double_spec.rb</code></p>

<p><em>Then</em> it should fail with the following output:</p>

<table><thead>
<tr>
<th></th>
</tr>
</thead><tbody>
<tr>
<td>2 examples, 1 failure</td>
</tr>
<tr>
<td></td>
</tr>
<tr>
<td>1) Account keeps track of the balance</td>
</tr>
<tr>
<td>Failure/Error: self.class.logger.log(&ldquo;Credited $#{amount}&rdquo;)</td>
</tr>
<tr>
<td>#<Double "Logger"> was originally created in one example but has leaked into another example and can no longer be used.</td>
</tr>
</tbody></table>
</article></section><footer><div>Created with the assistance of Ninefold<img src="/images/brutus-half.png" alt="Brutus" /></div><br /><a href="https://dnsimple.link/resolving-rspec" target="_blank">Resolving with<br /><img src="https://cdn.dnsimple.com/assets/resolving-with-us/logo-dark.png" alt="DNSimple" style="width:100px;" /></a></footer></body><script src="/javascripts/asciinema-player.js"></script></html>